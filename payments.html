<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Make payments for your LawConnect invoices">
  <title>Payment | LawConnect</title>
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <link rel="stylesheet" href="CaseManagementDashboard.css">
  <style>
    .payment-container {
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .payment-card {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
    }
    .payment-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .back-btn {
      margin-right: 15px;
      cursor: pointer;
    }
    .payment-title {
      font-size: 1.5rem;
      color: #002f5c;
      margin: 0;
    }
    .invoice-details {
      background: #f7fafc;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #e2e8f0;
    }
    .detail-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .detail-label {
      color: #718096;
      font-weight: 500;
    }
    .detail-value {
      color: #002f5c;
      font-weight: 600;
    }
    
    /* Paystack Form Styles */
    .momo-form {
      margin-top: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2d3748;
    }
    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 1rem;
    }
    .form-input:focus {
      outline: none;
      border-color: #3182ce;
      box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.2);
    }
    .input-error {
      border-color: #e53e3e;
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.2);
    }
    .error-message {
      color: #e53e3e;
      font-size: 0.8rem;
      margin-top: 5px;
      display: none;
    }
    .pay-now-btn {
      background: #1A00FF;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s ease;
    }
    .pay-now-btn:hover {
      background: #1500cc;
    }
    .pay-now-btn:disabled {
      background: #a0aec0;
      cursor: not-allowed;
    }
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="payment-container">
    <header class="payment-header">
      <div class="back-btn" onclick="window.history.back()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#002f5c" width="28" height="28">
          <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
        </svg>
      </div>
      <h1 class="payment-title">Make Payment</h1>
    </header>

    <div class="payment-card">
      <div class="invoice-details">
        <h3>Invoice Details</h3>
        <div class="detail-row">
          <span class="detail-label">Invoice #:</span>
          <span class="detail-value" id="invoice-number">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Client:</span>
          <span class="detail-value" id="invoice-client">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Amount:</span>
          <span class="detail-value" id="invoice-amount">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Due Date:</span>
          <span class="detail-value" id="invoice-due-date">-</span>
        </div>
      </div>

      <!-- Paystack Payment Form -->
      <div class="momo-form">
        <h3>Mobile Money Payment</h3>
        
        <div class="form-group">
          <label for="phoneNumber">Mobile Number</label>
          <input type="text" id="phoneNumber" class="form-input" maxlength="10" 
                 placeholder="e.g., 0201234567" oninput="formatPhoneNumber(this)">
          <div id="phoneNumberError" class="error-message">Please enter a valid Ghanaian number</div>
        </div>

        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" class="form-input" 
                 placeholder="your@email.com">
        </div>

        <div class="form-group">
          <label for="network">Mobile Network</label>
          <select id="network" class="form-input">
            <option value="">Select Network</option>
            <option value="MTN">MTN</option>
            <option value="Vodafone">Vodafone</option>
            <option value="AirtelTigo">AirtelTigo</option>
          </select>
        </div>

        <button id="pay-button" class="pay-now-btn" onclick="initiatePaystackPayment()">
          Pay with Mobile Money
          <div id="loading-spinner" class="loading-spinner"></div>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { verifyPayment } from './apiUtils.js';
    
    let currentInvoice = null;
    let invoiceAmount = 0;

    // Load invoice data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Get invoice ID from localStorage
      const invoiceId = localStorage.getItem('currentInvoice');
      
      if (!invoiceId) {
        alert('No invoice selected. Redirecting to invoices...');
        window.location.href = 'invoices.html';
        return;
      }

      loadInvoiceDetails(invoiceId);
    });

    function loadInvoiceDetails(invoiceId) {
      // Mock data - in real app, fetch from backend
      const mockInvoices = {
        'INV-2024-001': {
          number: 'INV-2024-001',
          client: 'ABC Corporation',
          amount: '5000.00',
          dueDate: 'July 30, 2024'
        },
        'INV-2024-002': {
          number: 'INV-2024-002',
          client: 'XYZ Holdings',
          amount: '3750.00',
          dueDate: 'July 15, 2024'
        },
        'INV-2024-003': {
          number: 'INV-2024-003',
          client: 'Smith Family Trust',
          amount: '7200.00',
          dueDate: 'June 30, 2024'
        },
        'INV-2024-004': {
          number: 'INV-2024-004',
          client: 'Johnson Legal',
          amount: '2500.00',
          dueDate: 'June 5, 2024'
        }
      };

      currentInvoice = mockInvoices[invoiceId] || mockInvoices['INV-2024-001'];
      invoiceAmount = parseFloat(currentInvoice.amount);

      // Update UI with invoice details
      document.getElementById('invoice-number').textContent = currentInvoice.number;
      document.getElementById('invoice-client').textContent = currentInvoice.client;
      document.getElementById('invoice-amount').textContent = `â‚µ${currentInvoice.amount}`;
      document.getElementById('invoice-due-date').textContent = currentInvoice.dueDate;
    }

    function formatPhoneNumber(input) {
      // Remove all non-digit characters
      let phone = input.value.replace(/\D/g, '');
      
      // Format as Ghanaian number (020 123 4567)
      if (phone.length > 3) {
        phone = phone.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
      } else if (phone.length > 2) {
        phone = phone.replace(/(\d{2})(\d+)/, '$1 $2');
      }
      
      input.value = phone;
    }

    function validatePhoneNumber(phone) {
      const cleanedPhone = phone.replace(/\D/g, '');
      // Ghanaian phone number validation
      return /^(20|24|26|27|28|29|30|50|54|55|56|57|59)[0-9]{7}$/.test(cleanedPhone);
    }

    function initiatePaystackPayment() {
      const phoneNumber = document.getElementById('phoneNumber').value;
      const email = document.getElementById('email').value;
      const network = document.getElementById('network').value;

      // Validate inputs
      if (!validatePhoneNumber(phoneNumber)) {
        document.getElementById('phoneNumberError').style.display = 'block';
        document.getElementById('phoneNumber').classList.add('input-error');
        return;
      }

      if (!network) {
        alert('Please select your mobile network');
        return;
      }

      // Show loading state
      const payButton = document.getElementById('pay-button');
      const loadingSpinner = document.getElementById('loading-spinner');
      payButton.disabled = true;
      loadingSpinner.style.display = 'inline-block';
      payButton.textContent = 'Processing...';

      const cleanedPhone = phoneNumber.replace(/\D/g, '');

      let handler = PaystackPop.setup({
        key: 'pk_test_7dcff291d3fd767b6947cf5177c49a4d29cc2c3a', // Your Paystack public key
        email: email || 'customer@lawconnect.com',
        amount: invoiceAmount * 100, // Convert to pesewas
        currency: 'GHS',
        channels: ['mobile_money'],
        metadata: {
          custom_fields: [
            {
              display_name: 'Invoice Number',
              variable_name: 'invoice_number',
              value: currentInvoice.number
            },
            {
              display_name: 'Mobile Number',
              variable_name: 'mobile_number',
              value: '+233' + cleanedPhone
            },
            {
              display_name: 'Mobile Network',
              variable_name: 'mobile_network',
              value: network
            }
          ]
        },
        callback: async function(response) {
          // Payment successful
          alert(`Payment successful! Reference: ${response.reference}`);
          
          // Send payment verification to your backend
          try {
            const paymentData = {
              reference: response.reference,
              invoiceNumber: currentInvoice.number,
              amount: invoiceAmount,
              status: 'success'
            };
            
            const result = await verifyPayment(paymentData);
            
            if (result.success) {
              alert(`Payment successful! Reference: ${response.reference}`);
              console.log('Payment verification successful:', result);
            } else {
              alert(`Payment processed but verification failed: ${result.message}`);
              console.error('Payment verification failed:', result);
            }
            
            // Redirect to invoices page
            window.location.href = 'invoices.html';
            
          } catch (error) {
            console.error('Payment verification error:', error);
            alert('Payment was successful but verification with our system failed. Please contact support with reference: ' + response.reference);
            window.location.href = 'invoices.html';
          }
        },
        onClose: function() {
          // User closed the payment modal
          payButton.disabled = false;
          loadingSpinner.style.display = 'none';
          payButton.textContent = 'Pay with Mobile Money';
          alert('Payment was cancelled');
        }
      });

      handler.openIframe();
    }

    // Remove error when user starts typing
    document.getElementById('phoneNumber').addEventListener('input', function() {
      this.classList.remove('input-error');
      document.getElementById('phoneNumberError').style.display = 'none';
    });
  </script>
</body>
</html>
